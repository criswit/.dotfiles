#!/usr/bin/env bash

# Rofi GPaste Modi Script
# This script acts as a modi (mode) for rofi to integrate GPaste clipboard manager
# Usage: rofi -modi "clipboard:rofi-gpaste-modi" -show clipboard

set -euo pipefail

# Check if running in rofi modi mode
if [[ -z "${ROFI_RETV:-}" ]]; then
    # Initial call - list clipboard entries
    gpaste-client --oneline 2>/dev/null | while IFS=: read -r uuid content; do
        # Clean up the content for display
        content="${content## }"  # Remove leading spaces
        # Truncate long entries and replace newlines
        content=$(echo "$content" | tr '\n' ' ' | cut -c1-100)
        # Display content as main text, store UUID as meta for selection
        echo -e "${content}\x00meta\x1f${uuid}"
    done
else
    # Handle selection
    case "${ROFI_RETV}" in
        0)
            # Initial call in modi mode
            gpaste-client --oneline 2>/dev/null | while IFS=: read -r uuid content; do
                content="${content## }"
                content=$(echo "$content" | tr '\n' ' ' | cut -c1-100)
                echo -e "${content}\x00meta\x1f${uuid}"
            done
            ;;
        1)
            # User selected an entry
            if [[ -n "${ROFI_INFO:-}" ]]; then
                # ROFI_INFO contains the UUID from meta
                gpaste-client select "${ROFI_INFO}" 2>/dev/null
                exit 0
            fi
            ;;
        10|11|12|13|14|15|16|17|18|19)
            # Custom keybindings (kb-custom-1 through kb-custom-10)
            case "${ROFI_RETV}" in
                10)  # kb-custom-1: Delete entry (Alt+d)
                    if [[ -n "${ROFI_INFO:-}" ]]; then
                        gpaste-client delete "${ROFI_INFO}" 2>/dev/null
                        # Continue showing the list
                        gpaste-client --oneline 2>/dev/null | while IFS=: read -r uuid content; do
                            content="${content## }"
                            content=$(echo "$content" | tr '\n' ' ' | cut -c1-100)
                            echo -e "${content}\x00meta\x1f${uuid}"
                        done
                    fi
                    ;;
                11)  # kb-custom-2: Clear history (Alt+c)
                    gpaste-client empty 2>/dev/null
                    echo "Clipboard history cleared"
                    ;;
                12)  # kb-custom-3: Show full entry (Alt+s)
                    if [[ -n "${ROFI_INFO:-}" ]]; then
                        gpaste-client get "${ROFI_INFO}" 2>/dev/null
                    fi
                    ;;
                *)
                    # Other custom keybindings - not implemented
                    ;;
            esac
            ;;
        *)
            # Unknown action
            ;;
    esac
fi